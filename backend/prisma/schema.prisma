// backend/prisma/schema.prisma
// Prisma schema for Portfolio Tracker

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  assets       Asset[]
  holdings     Holding[]
  transactions Transaction[]
  snapshots    PortfolioSnapshot[]
}

enum AssetCategory {
  ETF
  FCI
  CRYPTO
  CASH
}

enum TransactionType {
  BUY
  SELL
}

model Asset {
  id               String        @id @default(cuid())
  ticker           String
  name             String
  category         AssetCategory
  targetPercentage Decimal       @default(0)
  currentPriceCents BigInt?
  priceUpdatedAt   DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Relations
  userId       String
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  holding      Holding?
  transactions Transaction[]

  // Constraints
  @@unique([userId, ticker])
  @@index([userId])
}

model Holding {
  id        String   @id @default(cuid())
  quantity  Decimal  @db.Decimal(18, 8)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  assetId String @unique
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Transaction {
  id              String          @id @default(cuid())
  type            TransactionType
  date            DateTime
  quantity        Decimal         @db.Decimal(18, 8)
  priceCents      BigInt          // Price per unit in cents
  commissionCents BigInt          @default(0)
  totalCents      BigInt          // Calculated: (quantity × priceCents) ± commissionCents
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  assetId String
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([assetId])
  @@index([date])
}

model PortfolioSnapshot {
  id              String          @id @default(cuid())
  date            DateTime        @db.Date
  totalValueCents BigInt
  userId          String
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  assets          SnapshotAsset[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

model SnapshotAsset {
  id         String            @id @default(cuid())
  snapshotId String
  snapshot   PortfolioSnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)
  assetId    String
  ticker     String
  name       String
  quantity   Decimal           @db.Decimal(18, 8)
  priceCents BigInt
  valueCents BigInt
  percentage Decimal           @db.Decimal(5, 2)

  @@unique([snapshotId, assetId])
  @@index([snapshotId])
}
