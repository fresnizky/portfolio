// backend/prisma/schema.prisma
// Prisma schema for Portfolio Tracker

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                  String   @id @default(cuid())
  email               String   @unique
  passwordHash        String
  onboardingCompleted Boolean  @default(false)
  onboardingSkipped   Boolean  @default(false)
  rebalanceThreshold  Decimal  @default(5.0)  // Default 5% deviation threshold for rebalance alerts
  priceAlertDays      Int      @default(7)    // Default 7 days for price staleness alerts
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  assets       Asset[]
  holdings     Holding[]
  transactions Transaction[]
  snapshots    PortfolioSnapshot[]
}

enum AssetCategory {
  ETF
  FCI
  CRYPTO
  CASH
}

enum TransactionType {
  BUY
  SELL
}

enum Currency {
  USD
  ARS
}

model Asset {
  id               String        @id @default(cuid())
  ticker           String
  name             String
  category         AssetCategory
  currency         Currency      @default(USD)
  decimalPlaces    Int           @default(2)
  targetPercentage Decimal       @default(0)
  currentPrice     Decimal?      @db.Decimal(18, 8)
  priceUpdatedAt   DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Relations
  userId       String
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  holding      Holding?
  transactions Transaction[]

  // Constraints
  @@unique([userId, ticker])
  @@index([userId])
}

model Holding {
  id        String   @id @default(cuid())
  quantity  Decimal  @db.Decimal(18, 8)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  assetId String @unique
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Transaction {
  id         String          @id @default(cuid())
  type       TransactionType
  date       DateTime
  quantity   Decimal         @db.Decimal(18, 8)
  price      Decimal         @db.Decimal(18, 8)
  commission Decimal         @db.Decimal(18, 8) @default(0)
  total      Decimal         @db.Decimal(18, 8)
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  // Relations
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  assetId String
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([assetId])
  @@index([date])
}

model PortfolioSnapshot {
  id         String          @id @default(cuid())
  date       DateTime        @db.Date
  totalValue Decimal         @db.Decimal(18, 8)
  userId     String
  user       User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  assets     SnapshotAsset[]
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

model SnapshotAsset {
  id         String            @id @default(cuid())
  snapshotId String
  snapshot   PortfolioSnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)
  assetId    String
  ticker     String
  name       String
  quantity   Decimal           @db.Decimal(18, 8)
  price      Decimal           @db.Decimal(18, 8)
  value      Decimal           @db.Decimal(18, 8)
  percentage Decimal           @db.Decimal(5, 2)

  @@unique([snapshotId, assetId])
  @@index([snapshotId])
}

model ExchangeRate {
  id            String   @id @default(cuid())
  baseCurrency  Currency
  quoteCurrency Currency
  rate          Decimal  @db.Decimal(18, 8)
  source        String   @default("bluelytics")
  fetchedAt     DateTime
  createdAt     DateTime @default(now())

  @@unique([baseCurrency, quoteCurrency])
  @@index([fetchedAt])
}
